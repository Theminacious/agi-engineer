name: Manual Code Quality Check

on:
  workflow_dispatch:
    inputs:
      target_path:
        description: 'Path to analyze (default: entire repo)'
        required: false
        default: '.'
      use_ai:
        description: 'Enable AI analysis'
        required: false
        type: boolean
        default: true
      apply_fixes:
        description: 'Apply safe fixes automatically'
        required: false
        type: boolean
        default: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff groq anthropic requests gitpython
      
      - name: Run Analysis
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if [ "${{ inputs.apply_fixes }}" = "true" ]; then
            echo "üîß Running with fixes..."
            FLAGS="--smart"
          else
            echo "üîç Running analysis only..."
            FLAGS="--smart --analyze-only"
          fi
          
          if [ "${{ inputs.use_ai }}" = "true" ]; then
            FLAGS="$FLAGS --ai"
          fi
          
          python agi_engineer_v3.py "${{ inputs.target_path }}" $FLAGS
      
      - name: Show git diff (if fixes applied)
        if: inputs.apply_fixes == true
        run: |
          git diff --stat
          echo ""
          echo "Full diff:"
          git diff
      
      - name: Create Pull Request (if fixes applied)
        if: inputs.apply_fixes == true
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'fix: Auto-fix code quality issues'
          title: 'ü§ñ Auto-fix code quality issues'
          body: |
            ## Automated Code Quality Fixes
            
            This PR was automatically created by AGI Engineer.
            
            **Changes:**
            - Removed unused imports
            - Fixed useless f-strings
            - Other safe, automated fixes
            
            All changes have been verified as safe with 0 regressions.
            
            **Review:** Please review the changes and merge if acceptable.
          branch: agi-engineer-auto-fixes
          delete-branch: true
